import smtplib
import smail

from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.application import MIMEApplication

def send(msg: str) -> str:
    with smtplib.SMTP_SSL('bad-chess-challenge.dicec.tf', 1) as client:
        client.ehlo_or_helo_if_needed()
        client.mail('wtv@wtv')
        client.rcpt('wtv@wtv')
        return client.data(msg)[1].decode()

def make(src: str, dst: str, content: str, prev: str | None = None, sign: tuple[bytes, bytes] | None = None):
    msg = MIMEMultipart()
    msg['From'] = src
    msg['To'] = dst
    msg.attach(MIMEText(content))
    if prev:
        msg.attach(MIMEApplication(prev))
    if sign:
        return smail.sign_message(msg, *sign).as_string()
    return msg.as_string()

key, cert = send(make('ehhthing@chess', 'register@chess', 'n/a')).strip().split('\n\n')

sign = (key.encode(), cert.encode());

msg = make('admin@chess', 'admin@chess', 'e4', sign=sign)
for move in ['g5', 'd4', 'f6', 'Qh5']:
    msg = make('admin@chess', 'admin@chess', move, prev=msg, sign=sign)

print(send(msg))
